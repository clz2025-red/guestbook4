name: Deploy WAR to EC2 Tomcat  # 워크플로우 이름

on:
  push:
    branches:
      - master
  workflow_dispatch: # master 브랜치에 push 시 실행됨

jobs:
  deploy:
    runs-on: ubuntu-latest  # Ubuntu 서버에서 실행(깃허브의 코드를 war파일로 만들기 가상서버)

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3  # 저장소 코드 내려받음

    - name: Set up Java
      uses: actions/setup-java@v3  # Java 17 설치
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Build WAR with Maven
      run: mvn clean package -DskipTests  # WAR 빌드, 테스트 생략

    - name: Copy WAR to EC2 (to home directory)
      uses: appleboy/scp-action@v0.1.7  # SCP로 EC2에 WAR 복사
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: target/ROOT.war  # 빌드된 WAR 파일 경로
        target: /home/ec2-user/  # 복사 위치

    - name: Deploy WAR and restart Tomcat with sudo
		uses: appleboy/ssh-action@v1.0.3  # EC2에 SSH 접속 후 명령 실행
		with:
			host: ${{ secrets.EC2_HOST }}
			username: ${{ secrets.EC2_USER }}
			key: ${{ secrets.EC2_SSH_KEY }}
				script: |
				echo "[1] 기존 ROOT.war 및 ROOT 폴더 삭제"
				sudo rm -rf /usr/local/tomcat/webapps/ROOT.war
				sudo rm -rf /usr/local/tomcat/webapps/ROOT
	
				echo "[2] WAR 파일 이동 및 이름 변경"
				sudo mv /home/ec2-user/ROOT.war /usr/local/tomcat/webapps/ROOT.war
			  
				echo "[3] 톰캣 프로세스 종료 (없으면 무시)"
				sudo pkill -f tomcat || true
	
				echo "[4] 톰캣 시작"
				sudo /usr/local/tomcat/bin/startup.sh