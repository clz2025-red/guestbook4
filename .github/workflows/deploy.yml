name: Deploy WAR to EC2 Tomcat  # 워크플로우 이름

on:
  push:
    branches:
      - master
  workflow_dispatch:  # 수동 실행도 가능하게 설정

jobs:
  deploy:
    runs-on: ubuntu-latest  # GitHub에서 제공하는 Ubuntu 환경에서 실행

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3  # 저장소 코드 가져오기

      - name: Set up Java
        uses: actions/setup-java@v3  # Java 17 설치
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build WAR with Maven
        run: mvn clean package -DskipTests  # 테스트 생략하고 WAR 빌드

      - name: Copy WAR to EC2 (to home directory)
        uses: appleboy/scp-action@v0.1.7  # WAR 파일을 EC2 인스턴스로 전송
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "target/*.war"
          target: "/home/ec2-user/"
          strip_components: 1

      - name: Deploy WAR and restart Tomcat with sudo
        uses: appleboy/ssh-action@v1.0.3  # EC2 내에서 명령어 실행
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "[1] 기존 ROOT.war 및 ROOT 폴더 삭제"
            sudo rm -rf /usr/local/tomcat/webapps/ROOT.war
            sudo rm -rf /usr/local/tomcat/webapps/ROOT

            echo "[2] WAR 파일 이동 및 이름 변경"
            sudo mv /home/ec2-user/*.war /usr/local/tomcat/webapps/ROOT.war

            echo "[3] 톰캣 프로세스 종료 (없으면 무시)"
            sudo pkill -f tomcat || true

            echo "[4] 톰캣 시작"
            sudo /usr/local/tomcat/bin/startup.sh