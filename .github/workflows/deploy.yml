name: Deploy WAR to EC2 Tomcat  # ìë™í™” ì‘ì—… íë¦„ ì´ë¦„ (ì›Œí¬í”Œë¡œ)

on:
  #push:
  #  branches: [ "master" ]  # master ë¸Œëœì¹˜ì— push ì‹œ ì‹¤í–‰ë¨

  workflow_dispatch:        # ğŸ‘‰ GitHub í™”ë©´ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ë²„íŠ¼ ëˆŒëŸ¬ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ
  # ìœ„ ì„¤ì •ì„ ë„£ìœ¼ë©´ GitHub Actions íƒ­ì—ì„œ ë²„íŠ¼ í´ë¦­í•˜ì—¬ ì´ ì›Œí¬í”Œë¡œë¥¼ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥í•¨

  
jobs:
  deploy:
    runs-on: ubuntu-latest # GitHub Actionsê°€ ëª…ë ¹ì„ ì‹¤í–‰í•  ê°€ìƒì˜ Ubuntu ì„œë²„ í™˜ê²½ìœ¼ë¡œ, ëª¨ë“  ì¼ì´ ëë‚˜ë©´ ì´ ì„œë²„ëŠ” ì‚¬ë¼ì§

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3   # GitHub ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ í˜„ì¬ ê°€ìƒ ì„œë²„ë¡œ ë³µì‚¬í•´ì˜´

    - name: Set up Java
      uses: actions/setup-java@v3  # ê°€ìƒ ì„œë²„ì— Java í™˜ê²½ ì„¤ì¹˜
      with:
        java-version: '17'         # Java 17 ì„¤ì¹˜
        distribution: 'temurin'    # OpenJDK ë²„ì „ ì¤‘ í•˜ë‚˜ì¸ temurin ì‚¬ìš©

    - name: Build WAR with Maven
      run: mvn clean package  # Mavenì„ ì‚¬ìš©í•´ WAR íŒŒì¼ ìƒì„± (ì´ì „ì— ë§Œë“  íŒŒì¼ì€ ì‚­ì œí•˜ê³  ìƒˆë¡œ ë¹Œë“œ)

    - name: Copy WAR to EC2
      uses: appleboy/scp-action@v0.1.7  # ë¡œì»¬ì—ì„œ ì„œë²„(EC2)ë¡œ íŒŒì¼ ë³µì‚¬í•˜ëŠ” ëª…ë ¹ì–´ëª¨ìŒ(appleboyê°€ ë§Œë“¬)
      with:
        host: ${{ secrets.EC2_HOST }}             # EC2 IP
        username: ${{ secrets.EC2_USER }}         # EC2 ID
        key: ${{ secrets.EC2_SSH_KEY }}           # web.pem (SSH ì ‘ì†ì— í•„ìš”í•œ ê°œì¸í‚¤)
        source: target/ROOT.war                   # ë³µì‚¬í•  ì›ë³¸ íŒŒì¼ ê²½ë¡œ
        target: /home/ec2-user/                   # EC2 ì„œë²„ì˜ ë³µì‚¬ ìœ„ì¹˜
        overwrite: true                           # ê°™ì€ íŒŒì¼ëª…ì´ ì´ë¯¸ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°
        strip_components: 1                       # 'target/' ë””ë ‰í† ë¦¬ êµ¬ì¡°ëŠ” ì œê±°í•˜ê³ , íŒŒì¼ë§Œ ë³µì‚¬

    - name: Move WAR to Tomcat's webapps
      uses: appleboy/ssh-action@v1.0.3  # EC2 ì„œë²„ì— SSH ì ‘ì†í•´ ì•„ë˜ ëª…ë ¹ë“¤ì„ ì‹¤í–‰
      with:
        host: ${{ secrets.EC2_HOST }}         # EC2 IP
        username: ${{ secrets.EC2_USER }}     # EC2 ID
        key: ${{ secrets.EC2_SSH_KEY }}       # web.pem (SSH ì ‘ì†ìš© í‚¤)
        script: |
          echo "[1] ê¸°ì¡´ ROOT.war ë° ROOT í´ë” ì‚­ì œ"
          sudo rm -rf /usr/local/tomcat/webapps/ROOT.war     # ê¸°ì¡´ ROOT.war íŒŒì¼ ì‚­ì œ
          sudo rm -rf /usr/local/tomcat/webapps/ROOT         # ê¸°ì¡´ ROOT í´ë” ì‚­ì œ

          echo "[2] ìƒˆ WAR íŒŒì¼ ì´ë™"
          sudo mv /home/ec2-user/ROOT.war /usr/local/tomcat/webapps/ROOT.war  # ìƒˆ WAR íŒŒì¼ì„ Tomcat ê²½ë¡œë¡œ ì´ë™

          echo "[3] í†°ìº£ ì¢…ë£Œ"
          sudo /usr/local/tomcat/bin/shutdown.sh || true
          # shutdown.sh ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë¬´ì‹œí•˜ê³  ì •ìƒ ì²˜ë¦¬ (ì›Œí¬í”Œë¡œìš° ì§„í–‰ ì•ˆ ë©ˆì¶¤)

          echo "[4] ì ì‹œ ëŒ€ê¸°..."
          sleep 5  # í†°ìº£ì´ ì™„ì „íˆ ì¢…ë£Œë  ì‹œê°„ì„ ì£¼ê¸° ìœ„í•´ 5ì´ˆê°„ ëŒ€ê¸°

          echo "[5] í†°ìº£ ì¬ì‹œì‘"
          sudo /usr/local/tomcat/bin/startup.sh  # í†°ìº£ ì„œë²„ ì‹œì‘
